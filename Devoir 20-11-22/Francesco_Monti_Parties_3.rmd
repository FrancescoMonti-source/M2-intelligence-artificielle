---
title: "Homework part 3"
author: "Francesco MONTI"
date: "2022-11-17"
output: pdf_document
option: echo = F
---

```{r libraries}
library(stringr)
library(prettyR)
library(ggplot2)
library(ggthemes)
library(colorRamps)

knitr::opts_chunk$set(echo = F, warning = F) # setting chunk options globally
```

## 1) Import the file "BDD_VICAN.csv"

```{r}
data <- read.csv("BDD_VICAN.csv", sep = ";", dec = ",", encoding = "UTF-8")

names(data) = tolower(names(data)) # removing capital letters as working with them can be annoying
```

## 2) Display the first lines of the dataset. Display the lines 1; 4; 18; 103 of the dataset

```{r echo=F}
head(data) # first lines

data[c(1, 4, 18, 103), ] # lines 1,4,18,103

```

## 3. How many variables and observations are there?

```{r echo=F}
ncol(data) # variables count

nrow(data) # observations count
```

## 4. Does this file contain any missing values?

```{r}
sapply(data, function(x) sum(is.na(x))) # NAs by variable

sum(is.na(data)) # global NAs
```

On a first impression, the dataframe looks to be free of any NAs. We'll see later that this is not true: the variable "q5_eortc_fatigue_r1" as been incorrectly identified as "character" as missing values have been tagged as "!NULL" rather than leaving the cells empty.

As a sidenote, there is no description of "q5_eortc_fatigue_r1" in the statement of the homework

## 5. What is the nature of the variables studied?

```{r}
str(data)
```

## 6. Some of the variables are in the wrong format, for example, a qualitative variable in "numeric" format. Based on the description of each variable (found at the beginning of this exercise), recode the variable(s) into the correct format

```{r}
data$q5_eortc_fatigue_r1 = as.numeric(str_replace(data$q5_eortc_fatigue_r1, ",", "."))  # replacing "," with "." is necessary for as.numeric() to work correctly


sum(is.na(data$q5_eortc_fatigue_r1))  # 6 NAs introduced where cells were "!NULL"

# For several variables it could be appropriate to convert them to factors but, as working with factors can be at times, annoying, i would rather wait and see.


```

## 7. Definition of clinically significant fatigue score: score \>= 40 on the fatigue scale included in the survey, the threshold at which a fatigue condition was shown to be clinically significant. Create a categorical variable based on this definition.

```{r}
data$q5_eortc_fatigue_r1_fac = 
  cut(data$q5_eortc_fatigue_r1, 
      breaks = c(0,40,100), 
      labels = c("Clinically significant", "Not clinically significant"), 
      include.lowest = T)
```

## 8. Group the modalities of the variable sequelae into 3 modalities.
This new variable, named "Q5_med23.1_rec" will be considered in the following analyses instead of "Q5_med23.1".

```{r}
data$q5_med23.1_rec = factor(data$q5_med23.1, 
                             levels = c(1,2,3,4,5), 
                             labels = c("Important sequelae","Important sequelae", "Moderate sequelae", "Moderate sequelae", "No sequelae"))
```

## 9. Display the frequency table for this new variable.

```{r}
a = table(data$q5_med23.1_rec)
b = paste(round(prop.table(table(data$q5_med23.1_rec))*100,2),"%")
rbind(a,b)
```

## 10. Concerning age: What is the average age of our study population, then that of breast cancer. 

```{r}
whole_pop = data$fc_agediag_r0
breast_pop = data$fc_agediag_r0[which(data$ms_codcancer==1)] # 1 = "Breast"

mean(whole_pop) # Mean age of our population

mean(breast_pop) # mean age for breast cancer subpopulation. 
```

### Determine the 95% confidence intervals (CI) for each of the calculated means.

```{r}
t.test(whole_pop)$"conf.int" # T confidence intervals for the whole population

t.test(breast_pop)$"conf.int" # T confidence interval for the breast cancer subpopulation
```

### Calculate the variance, standard deviation of the sample, then that of breast cancer.

```{r}
describe(whole_pop,num.desc=c("var","sd"), xname="the age variable for the whole population", horizontal=FALSE)

describe(breast_pop,num.desc=c("var","sd"), xname="the age variable for the breast cancer population", horizontal=FALSE)
```

## 11. Draw a graph that will represent the distribution of age by location of the pathology. Choose the most appropriate graph. Export the graph in a pdf format.

```{r}
# Recoding ms_codcancer as a factor will simplify the generation of a ggplot graph
data$ms_codcancer = factor(data$ms_codcancer, labels = c("Breast", "Lung", "Colon & Rectum", "Prostate", "VADS", "Bladder", "Kidney", "Thyroid", "Lymphoma", "Melanoma", "Cervix", "Uterus"))

# Solution 1
ggplot(data = data, 
       aes(x=fc_agediag_r0, group = ms_codcancer, fill = ms_codcancer)) +
    geom_density()+
    scale_fill_brewer(palette="Set3")+
    scale_y_continuous(breaks = seq(0,0.1, 0.01), minor_breaks = seq(0, 0.005, 0.01))+
    scale_x_continuous(breaks = seq(0,100, 5))+
    labs(x = "Age",
         y = "Distribution probability",
         title = "Age distribution by cancer location",
         fill = "Cancer location")+
    facet_grid(vars(ms_codcancer))+
    theme(strip.text.y = element_text(size = 7))

ggsave("Solution 1.pdf", plot = last_plot(), device = "pdf", dpi = 300, width = 20, height = 35, units = "cm")

# Solution 2
ggplot(data = data, 
       aes(x=fc_agediag_r0, group = ms_codcancer, fill = ms_codcancer)) +
  geom_density()+
  scale_fill_brewer(palette="Set3")+
  scale_y_continuous(breaks = seq(0,0.1, 0.01), minor_breaks = seq(0, 0.005, 0.01))+
  scale_x_continuous(breaks = seq(0,100, 5))+
  labs(x = "Age",
       y = "Distribution probability",
       title = "Age distribution by cancer location",
       fill = "Cancer location")+
    facet_wrap(vars(ms_codcancer))

ggsave("Solution 2.pdf", plot = last_plot(), device = "pdf", dpi = 300, width = 40, height = 30, units = "cm")

# Solution 3
ggplot(data = data, 
       aes(x=fc_agediag_r0, group = ms_codcancer, colour = ms_codcancer)) +
    geom_density(stat = "bin", linewidth = 1.2, alpha = .4)+
    scale_color_manual(values = primary.colors(n=12, step = 6))+
    scale_x_continuous(breaks = seq(0,100, 5))+
    scale_y_continuous(breaks = seq(0,1000, 10))+
    labs(x = "Age",
         y = "Count",
         title = "Age distribution by cancer location",
         colour = "Cancer location")+ theme_excel()

ggsave("Solution 3.pdf", plot = last_plot(), device = "pdf", dpi = 300, width = 25, height = 20, units = "cm")
```

## 12. Determine the factors associated with physical and then mental quality of life, including variables with a p-value \< 0.2. Which model will you use? How will you proceed? Interpret the final result.

```{r}

```

## 13. Export the new database in ".csv" format.

```{r}

```

## 












